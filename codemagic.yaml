workflows:
  ios-workflow:
    name: Build iOS app
    max_build_duration: 90
    environment:
      node: 20.0.0
      xcode: latest
    scripts:
      - name: Install dependencies
        script: |
          npm install
          npm install @capacitor/ios
      - name: Clean previous web build
        script: rm -rf www
      - name: Build web assets
        script: npx ionic build
      - name: Copy web assets to iOS
        script: npx cap copy ios
      - name: Sync iOS platform
        script: npx cap sync ios
      - name: Build iOS app with Xcode
        script: |
          xcodebuild -workspace ios/App/App.xcworkspace \
           -scheme App \
           -sdk iphoneos \
           -configuration Release \
           archive \
           -archivePath $CM_BUILD_DIR/build/App.xcarchive \
           CODE_SIGN_STYLE=Manual

    artifacts:
      - build/App.xcarchive

    publishing:
      app_store_connect:
        apple_id: "sivapp.daniele@yahoo.com"
        password: "xztd-gmzc-pviw-egxy"
        bundle_id: "com.daniele.sivapp"
        submit_to_testflight: true

    code_signing:
      ios:
        distribution_certificate:
          p12: "Daniele Doppiu"
          password: "Dgra75"
        provisioning_profile:
          bundle_identifier: "com.daniele.sivapp"
          profile: "SivappProfile"
